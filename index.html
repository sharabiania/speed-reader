<!DOCTYPE html>

<html>
    <head>
		<meta name="viewport" content="width=device-width" />
        <style>
            /*** a-Theme ***/
            *{box-sizing: border-box;}
            *:focus {outline: 0;}
            html, body {height: 100%;}            
            body {font-family: "Open Sans","Calibri","sans-serif";background-color:wheat;margin: 1%;text-align: center;}
            button {background-color: whitesmoke; cursor: pointer; margin:5px;padding: 10px;border-style: double; border-color:#cccccc;text-transform: capitalize;}        
            button:hover{border-color:#aaaaaa;}                                 
            ::selection{background-color: darkslategray;color:aliceblue;}
            ::-webkit-scrollbar{width:8px;cursor: -webkit-grab;}     
            ::-webkit-scrollbar-track:hover{background: #eeeeee;cursor: pointer;}
            ::-webkit-scrollbar-thumb {border-radius: 10px;background: #cccccc;}
            /*** END a-Theme ***/
            
            #a-screen{display: table;background-color: lightgrey;  margin: auto; width: 100%; height: 70%}
            #a-text {display:table-cell; vertical-align: middle; margin:auto;
             width: 100%; height: 100%; line-height: 100%; 
             font-size:40px;
             font-family: sans-serif;
             }
            #a-progress {width: 100%;}             
            #a-slider:hover {background-color: darkgray;cursor: pointer;}
            #a-label{font-size: 14px; font-style: italic;}
            #a-label::after{content: " words per minute"}
            #a-input {width: 40%;resize: none;}			
            .a-btn-play::after{content: "read";}
            .a-btn-pause {background-color:#cccccc;}
            .a-btn-pause::after{content: "pause";}
            
            .a-flex {display: flex;padding: 5px;}
            .a-flex > div {flex-grow: 0; flex-basis: 33%;}
            .a-flex > div:last-child {text-align: right;}
            .a-flex > div:first-child {text-align: left;}

			.a-container {width: 40%; height:60%;min-height: max-content;background-color: lightgray;margin: auto;}
		 			 
			 @media only screen and (max-width: 400px) {
				html, body {padding: 0; margin:0;}
				.a-container {width: 100%;}
				#a-input {width:100%; height: 40%;}
				 

			 }
        </style>
    </head>
    <body>
        <div class="a-container">
            <div id="a-screen">
                <div id="a-text">Push the button!</div>
            </div>       
            <progress id="a-progress" value="0" max="100"></progress>
            <br/><hr>
            <div class="a-flex">
                <div><button onclick="reset()">Reset</button></div>
                <div>
                    <input id="a-slider" type="range" min="100" max="700" step="50"/>
                    <br/>
                    <label id="a-label" for="a-slider"></label>
				</div>
				<div>
					<select id="a-select">
						<option value="1" selected="selected">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
					</select> words
				</div>
                <div><button id="a-play"  class="a-btn-play"></button></div>                
            </div>
        </div>
        <textarea id="a-input" rows="8"></textarea>
        <script>
			
			var variable = function(element){
				return function () {
					if(arguments.length > 0) 
						element.value = arguments[0];					
				
					else return element.value;													
				}
			}

            var div = document.getElementById("a-text");                       
			var progress = new variable(document.getElementById("a-progress"));
			var s = 0;
			var pause = true;		
			var i = 0;
			var n = document.getElementById("a-select").value;
			const initval = 100;
			
			document.getElementById("a-input").value = 
            "Paste some text that you want to speed read, then press \"Read\" button."
            +"\nYou can change the speed using the slider, or pause at any time.";

			document.getElementById("a-play").addEventListener('click', run);
			document.getElementById("a-slider").addEventListener('change', changeDelay);   
			document.getElementById("a-slider").value = initval;
			document.getElementById("a-label").innerText = initval;
			document.getElementById("a-select").addEventListener('change', function(){				
				n = this.value;
				var wpm = document.getElementById("a-slider").value;
				s = Math.floor((60 / (wpm / n)) * 1000); 
			});
            
            function changeDelay(event) {
				document.getElementById('a-label').innerText = event.target.value;
				// TODO fix this formula.
                s = Math.floor((60 / (event.target.value / n)) * 1000);                
            }
            
            function run() {
                
                document.getElementById("a-slider").dispatchEvent(new Event('change'));
                this.classList.toggle("a-btn-play");
                this.classList.toggle("a-btn-pause");
                var element = this;
                pause = !pause;

                var text = document.getElementById("a-input").value;              
                var words = text.match(/\b(\w+\W+)/g);
                              
                (function loop(){
					div.innerText = "";
					var temp = "";
					for(var j = 0; j < n; ++j)
					{
						if(i < words.length)
							temp += words[i++];
					}
					div.innerText = temp;
                    progress((i  / (words.length)) * 100); 
                    if(pause === false)
                    {      						                               
                        if(i < words.length){
                            setTimeout(loop, s, i);
                        }
                        else {
                            i = 0; 
                            element.className = "a-btn-play";
                            progress(100);
                            pause = true;
                        }
                        
                    }
                })();
              
            }

            function reset() {                
                i = 0;
                progress(0);
            }


        </script>
    </body>

</html>